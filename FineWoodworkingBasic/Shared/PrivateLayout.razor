@inherits MainLayout

@inject NavigationManager NavManager
@using FineWoodworkingBasic.Authentication;
@using FineWoodworkingBasic.Authentication.Provider;
@using System.Security.Claims;
@using Microsoft.AspNetCore.Components.Authorization;
@using Microsoft.AspNetCore.Identity;
@using Microsoft.Data.SqlClient;
@using FineWoodworkingBasic.Util;
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationService AuthenticationService
@inject UsersTable ut

@using Service;

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />


<AuthorizeView>
    <NotAuthorized>
        @{
            redirect();
        }
    </NotAuthorized>
    <Authorized>
<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton 
            Icon="@Icons.Material.Filled.Menu" 
            Color="Color.Inherit" 
            Edge="Edge.Start" 
            OnClick="@((e) => DrawerToggle())" />
        <MudSpacer />
        <MudButton 
            Href="/" 
            StartIcon="@garage" 
            IconColor="Color.Tertiary" 
            DisableElevation="true">
            @*<MudButton Href="private" StartIcon="@garage" IconColor="Color.Tertiary" DisableElevation="true">*@
                <MudText 
                    Typo="Typo.h6" 
                    Class="px-4" 
                    Align="Align.Center" 
                    Color="Color.Inherit">
                    Garage Shop Woodworking - Private
                </MudText>
        </MudButton>
        <MudSpacer />
        <MudSpacer />
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.TwoTone.Logout" Color="Color.Tertiary" OnClick="ToggleOverlay" />
            <MudPopover
                Open="login.IsOverlayOpen()" 
                Class="my-1"
                OverflowBehavior="OverflowBehavior.FlipAlways" 
                AnchorOrigin="Origin.BottomRight" 
                TransformOrigin="Origin.TopRight"
                Paper="false"
                Duration="300">
                <Logout ParentUpdate="UpdateParent"/>
            </MudPopover>
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" Elevation="2">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">Navigation</MudText>
        </MudDrawerHeader>
        <MudDivider DividerType="DividerType.Middle" />
        <PrivateNavMenu />
    </MudDrawer>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="pt-8">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>
    </Authorized>
</AuthorizeView>




@code {

    AccountLogin login = new AccountLogin();
    bool _drawerOpen = true;

    void ToggleOverlay()
    {
        login.ToggleOverlay();
    }

    public void UpdateParent(){
        NavManager.NavigateTo(login.GetLinkAddress());
        StateHasChanged();
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    void redirect()
    {
        try
        {
            NavManager.NavigateTo(NavManager.BaseUri, true);
        }
        catch (NavigationException)
        {
            // Do nothing?
            // Exception is thrown but redirect still works.
            Console.WriteLine("NavigationException thrown.");
        }
    }

    #region Icons
    const string garage =
    @"<svg xmlns=""http://www.w3.org/2000/svg"" height=""1em"" viewBox=""0 0 640 512""><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d=""M0 488V171.3c0-26.2 15.9-49.7 40.2-59.4L308.1 4.8c7.6-3.1 16.1-3.1 23.8 0L599.8 111.9c24.3 9.7 40.2 33.3 40.2 59.4V488c0 13.3-10.7 24-24 24H568c-13.3 0-24-10.7-24-24V224c0-17.7-14.3-32-32-32H128c-17.7 0-32 14.3-32 32V488c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24zm488 24l-336 0c-13.3 0-24-10.7-24-24V432H512l0 56c0 13.3-10.7 24-24 24zM128 400V336H512v64H128zm0-96V224H512l0 80H128z"" /></svg>";

    #endregion
}